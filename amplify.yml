version: 1
frontend:
  phases:
    preBuild:
      commands:
        - npm install -g pnpm
        - pnpm install --frozen-lockfile
        - echo "Checking environment variables..."
        - echo "NODE_ENV=$NODE_ENV"
        - echo "NEXTAUTH_URL=$NEXTAUTH_URL"
        - echo "NEXTAUTH_SECRET=$(if [ -z "$NEXTAUTH_SECRET" ]; then echo "‚ùå MISSING"; else echo "‚úÖ SET"; fi)"
        - echo "GOOGLE_CLIENT_ID=$(if [ -z "$GOOGLE_CLIENT_ID" ]; then echo "‚ùå MISSING"; else echo "‚úÖ SET"; fi)"
        - echo "GOOGLE_CLIENT_SECRET=$(if [ -z "$GOOGLE_CLIENT_SECRET" ]; then echo "‚ùå MISSING"; else echo "‚úÖ SET"; fi)"
        - echo "NEXT_PUBLIC_SUPABASE_URL=$(if [ -z "$NEXT_PUBLIC_SUPABASE_URL" ]; then echo "‚ùå MISSING"; else echo "‚úÖ SET"; fi)"
        - echo "NEXT_PUBLIC_SUPABASE_ANON_KEY=$(if [ -z "$NEXT_PUBLIC_SUPABASE_ANON_KEY" ]; then echo "‚ùå MISSING"; else echo "‚úÖ SET"; fi)"
        - echo "SUPABASE_SERVICE_ROLE_KEY=$(if [ -z "$SUPABASE_SERVICE_ROLE_KEY" ]; then echo "‚ùå MISSING"; else echo "‚úÖ SET"; fi)"
    build:
      commands:
        - echo "Building for production with NODE_ENV=$NODE_ENV"
        - echo "Starting Next.js build process..."
        - pnpm run build
        - echo "Build completed successfully!"
    postBuild:
      commands:
        - echo "=== Build Summary ==="
        - echo "‚úÖ Next.js build completed"
        - echo "üîç Final environment check:"
        - echo "   NEXTAUTH_URL: $NEXTAUTH_URL"
        - echo "   Required variables status:"
        - echo "   - NEXTAUTH_SECRET: $(if [ -z "$NEXTAUTH_SECRET" ]; then echo "‚ùå MISSING - Auth will not work"; else echo "‚úÖ SET"; fi)"
        - echo "   - GOOGLE_CLIENT_ID: $(if [ -z "$GOOGLE_CLIENT_ID" ]; then echo "‚ùå MISSING - Google login will not work"; else echo "‚úÖ SET"; fi)"
        - echo "   - SUPABASE_URL: $(if [ -z "$NEXT_PUBLIC_SUPABASE_URL" ]; then echo "‚ùå MISSING - Database will not work"; else echo "‚úÖ SET"; fi)"
        - echo "   - SUPABASE_SERVICE_KEY: $(if [ -z "$SUPABASE_SERVICE_ROLE_KEY" ]; then echo "‚ùå MISSING - Email signup will not work"; else echo "‚úÖ SET"; fi)"
        - echo ""
        - echo "üöÄ If any variables are missing, add them in Amplify Console > App Settings > Environment Variables"
  artifacts:
    baseDirectory: .next
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/*
  environment:
    variables:
      NODE_ENV: production
      NEXTAUTH_URL: https://grassrootskw.org
      _LIVE_UPDATES: '[{"name":"Next.js","pkg":"next","type":"framework","version":"15.4.6"}]'
      # 
      # ‚ö†Ô∏è  REQUIRED ENVIRONMENT VARIABLES TO SET IN AMPLIFY CONSOLE:
      # 
      # Go to: AWS Amplify Console > Your App > App Settings > Environment Variables
      # Add these variables with their actual values:
      #
      # NEXTAUTH_SECRET=your-32-character-secret-key
      # GOOGLE_CLIENT_ID=your-google-oauth-client-id  
      # GOOGLE_CLIENT_SECRET=your-google-oauth-client-secret
      # NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
      # NEXT_PUBLIC_SUPABASE_ANON_KEY=your-supabase-anon-key
      # SUPABASE_SERVICE_ROLE_KEY=your-supabase-service-role-key
      #
      # üîç The preBuild phase will check if these variables are set
      # üö® Without these variables, authentication and database features will not work

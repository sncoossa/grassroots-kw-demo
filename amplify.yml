version: 1
frontend:
  phases:
    preBuild:
      commands:
        - npm install -g pnpm
        - pnpm install --frozen-lockfile
        - echo "Checking environment variables..."
        - echo "NODE_ENV is $NODE_ENV"
        - echo "NEXTAUTH_URL is $NEXTAUTH_URL"
        - 'if [ -z "$NEXTAUTH_SECRET" ]; then echo "NEXTAUTH_SECRET: MISSING"; else echo "NEXTAUTH_SECRET: SET"; fi'
        - 'if [ -z "$GOOGLE_CLIENT_ID" ]; then echo "GOOGLE_CLIENT_ID: MISSING"; else echo "GOOGLE_CLIENT_ID: SET"; fi'
        - 'if [ -z "$GOOGLE_CLIENT_SECRET" ]; then echo "GOOGLE_CLIENT_SECRET: MISSING"; else echo "GOOGLE_CLIENT_SECRET: SET"; fi'
        - 'if [ -z "$NEXT_PUBLIC_SUPABASE_URL" ]; then echo "NEXT_PUBLIC_SUPABASE_URL: MISSING"; else echo "NEXT_PUBLIC_SUPABASE_URL: SET"; fi'
        - 'if [ -z "$NEXT_PUBLIC_SUPABASE_ANON_KEY" ]; then echo "NEXT_PUBLIC_SUPABASE_ANON_KEY: MISSING"; else echo "NEXT_PUBLIC_SUPABASE_ANON_KEY: SET"; fi'
        - 'if [ -z "$SUPABASE_SERVICE_ROLE_KEY" ]; then echo "SUPABASE_SERVICE_ROLE_KEY: MISSING"; else echo "SUPABASE_SERVICE_ROLE_KEY: SET"; fi'
    build:
      commands:
        - echo "Building for production with NODE_ENV=$NODE_ENV"
        - echo "Creating .env.production file with runtime environment variables..."
        - |
          cat > .env.production << EOF
          # Generated during Amplify build - DO NOT EDIT MANUALLY
          # This file ensures environment variables are available at Next.js runtime
          NODE_ENV=production
          NEXTAUTH_URL=${NEXTAUTH_URL}
          NEXTAUTH_SECRET=${NEXTAUTH_SECRET}
          GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
          GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
          SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}
          # NEXT_PUBLIC_ variables are bundled at build time, no need to include here
          EOF
        - echo "Generated .env.production file:"
        - cat .env.production
        - echo "Starting Next.js build process..."
        - pnpm run build
        - echo "Build completed successfully!"
    postBuild:
      commands:
        - echo "=== Build Summary ==="
        - echo "Next.js build completed"
        - echo "Final environment check:"
        - echo "NEXTAUTH_URL is $NEXTAUTH_URL"
        - echo "Required variables status:"
        - 'if [ -z "$NEXTAUTH_SECRET" ]; then echo "NEXTAUTH_SECRET: MISSING - Auth will not work"; else echo "NEXTAUTH_SECRET: SET"; fi'
        - 'if [ -z "$GOOGLE_CLIENT_ID" ]; then echo "GOOGLE_CLIENT_ID: MISSING - Google login will not work"; else echo "GOOGLE_CLIENT_ID: SET"; fi'
        - 'if [ -z "$NEXT_PUBLIC_SUPABASE_URL" ]; then echo "SUPABASE_URL: MISSING - Database will not work"; else echo "SUPABASE_URL: SET"; fi'
        - 'if [ -z "$SUPABASE_SERVICE_ROLE_KEY" ]; then echo "SUPABASE_SERVICE_KEY: MISSING - Email signup will not work"; else echo "SUPABASE_SERVICE_KEY: SET"; fi'
        - echo "If any variables are missing, add them in Amplify Console App Settings Environment Variables"
  artifacts:
    baseDirectory: .next
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/*
  environment:
    variables:
      NODE_ENV: production
      _LIVE_UPDATES: '[{"name":"Next.js","pkg":"next","type":"framework","version":"15.4.6"}]'
      # Environment variables are now injected via .env.production file during build
      # 
      # ‚ö†Ô∏è  REQUIRED ENVIRONMENT VARIABLES TO SET IN AMPLIFY CONSOLE:
      # 
      # Go to: AWS Amplify Console > Your App > App Settings > Environment Variables
      # Add these variables with their actual values:
      #
      # NEXTAUTH_SECRET=your-32-character-secret-key
      # GOOGLE_CLIENT_ID=your-google-oauth-client-id  
      # GOOGLE_CLIENT_SECRET=your-google-oauth-client-secret
      # NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
      # NEXT_PUBLIC_SUPABASE_ANON_KEY=your-supabase-anon-key
      # SUPABASE_SERVICE_ROLE_KEY=your-supabase-service-role-key
      #
      # üîç The preBuild phase will check if these variables are set
      # üö® Without these variables, authentication and database features will not work
